```{r, message = FALSE, warning = FALSE, echo = FALSE}
devtools::load_all()
```
## 学習された特徴量 {#cnn-features}
<!--## Learned Features {#cnn-features}-->

`r if(is.html){only.in.html}`

<!--
Convolutional neural networks learn abstract features and concepts from raw image pixels.
[Feature Visualization](#feature-visualization) visualizes the learned features by activation maximization.
[Network Dissection](#network-dissection) labels neural network units (e.g. channels) with human concepts.
-->
畳み込みニューラルネットワークは抽象的な特徴量や、元画像ピクセルから概念を学習します。
[特徴量の可視化](#feature-visualization)では学習された特徴量を activation maximization により可視化します。
[ネットワーク分析](#network-dissection)ではニューラルネットワークのユニット（チャネルなど）を人間の理解によってラベル付けします。


<!-- Background: Why feature visualization -->
<!--Deep neural networks learn high-level features in the hidden layers.
This is one of their greatest strengths and reduces the need for feature engineering.
Assume you want to build an image classifier with a support vector machine.
The raw pixel matrices are not the best input for training your SVM, so you create new features based on color, frequency domain, edge detectors and so on.
With convolutional neural networks, the image is fed into the network in its raw form (pixels).
The network transforms the image many times.
First, the image goes through many convolutional layers.
In those convolutional layers, the network learns new and increasingly complex features in its layers.
Then the transformed image information goes through the fully connected layers and turns into a classification or prediction.
-->
<!--背景: なぜ特徴量の可視化をするのか-->
深層ニューラルネットワークは隠れ層で高レベルの特徴量を学習します。
これは深層ニューラルネットワークの最も重要な強みの1つで、特徴量に関する作業を減らします。
サポートベクターマシンによる画像分類器を構成したいと仮定して下さい。
生のピクセル行列は SVM の訓練に最も良い入力形式ではないため、色、周波数領域、輪郭検出器などの新たな特徴量を作りだす必要があります。
畳み込みニューラルネットワークでは、画像は生の形式(ピクセル)のままネットワークに与えられます。
ネットワークは画像を何度も変換します。
初めに、画像は多数の畳み込み層を通過します。
それらの畳み込み層では、ネットワークは新たな、そして次第に複雑な特徴量をその層において学習します。
その後、変換された画像の情報は全結合層を通過し、分類や予測へ変化します。

<!--
fig.cap = "Architecture of Inception V1 neural network. Each enumerated unit (3a to 5b) represents a layer with differently sized convolutions and pooling. Figure from Olah, et al. 2019 (CC-BY 4.0) https://distill.pub/2017/activation-atlas/."
-->

```{r fig.cap = "Inception V1 ニューラルネットワークの構造。それぞれの列挙されたユニット(3aから5b)は異なるサイズの畳み込みとプーリング層を表している。Olah, et al. 2019 (CC-BY 4.0) https://distill.pub/2017/activation-atlas/", out.width = 800, include = FALSE}
knitr::include_graphics("images/inceptionv1.svg")
```

<!--
fig.cap = "Features learned by a convolutional neural network (Inception V1) trained on the ImageNet data. The features range from simple features in the lower convolutional layers (left) to more abstract features in the higher convolutional layers (right). Figure from Olah, et al. 2017 (CC-BY 4.0) https://distill.pub/2017/feature-visualization/appendix/."
-->

```{r fig.cap = "ImageNet データにより訓練された畳み込みニューラルネットワーク (Inception V1) による、学習された特徴量。特徴量は、低い畳み込み層(左)の単純な特徴量から、高い畳み込み層(右)のより抽象的な特徴量までの範囲を持つ。Olah, et al. 2017 (CC-BY 4.0) https://distill.pub/2017/feature-visualization/appendix/.", out.width = 800}
knitr::include_graphics("images/cnn-features.png")
```

<!--
- The first convolutional layer(s) learn features such as edges and simple textures.
- Later convolutional layers learn features such as more complex textures and patterns.
- The last convolutional layers learn features such as objects or parts of objects.
- The fully connected layers learn to connect the activations from the high-level features to the individual classes to be predicted.
-->
- 最初の畳み込み層は輪郭や単純なテクスチャといった特徴量を学習します。
- その後の畳み込み層はより複雑なテクスチャや模様といった特徴量を学習します。
- 最後の特徴量は物体や物体の一部といた特徴量を学習します。
- 全結合層は、高レベル特徴量からの活性化を予測されるべき個別のクラスへと接続するよう学習します。

<!--
Cool.
But how do we actually get those hallucinatory images?
-->
クールですね。
しかし、実際にはどのようにそんな幻覚めいた画像を得ているのでしょうか？

### 特徴量の可視化
<!--### Feature Visualization {#feature-visualization}-->

<!-- Feature Visualization explained-->
<!--The approach of making the learned features explicit is called **Feature Visualization**.
Feature visualization for a unit of a neural network is done by finding the input that maximizes the activation of that unit.-->
学習された特徴量を明示的なものにしようとする試みを**特徴量の可視化**と呼びます。
ニューラルネットワークのあるユニットの特徴量の可視化はその部分の活性化関数を最大化する入力を見つけることによって行います。

<!--"Unit" refers either to individual neurons, channels (also called feature maps), entire layers or the final class probability in classification (or the corresponding pre-softmax neuron, which is recommended).
Individual neurons are atomic units of the network, so we would get the most information by creating feature visualizations for each neuron.-->
「ユニット」はそれぞれのニューロン、チャンネル(特徴量マップとも呼ばれる)、全体の層、およびクラス分類における最終的なクラスの確率(や対応するソフトマックスの前のニューロン、これが推奨される)のことを指します。

<!--But there is a problem: 
Neural networks often contain millions of neurons.
Looking at each neuron's feature visualization would take too long.
The channels (sometimes called activation maps) as units are a good choice for feature visualization.
We can go one step further and visualize an entire convolutional layer.
Layers as a unit are used for Google's DeepDream, which repeatedly adds the visualized features of a layer to the original image, resulting in a dream-like version of the input.-->
しかし、問題があります。
ニューラルネットはしばしば何百万ものニューロンを含むことがあります。
それぞれのニューロンの特徴量の可視化を見ることはあまりにも時間がかかりすぎるでしょう。
ユニットとしてのチャンネル(activation map とも呼ばれることもある) は特徴量を可視化するのに良い選択となります。
もう一段上がって全体の畳み込み層を可視化できます。
ユニットとしての層が Google の DeepDream で使われています、これは元の画像に繰り返し可視化された特徴量を加えることで、入力の夢バージョンを出力するものです。

<!--
fig.cap="Feature visualization can be done for different units. A) Convolution neuron, B) Convolution channel, C) Convolution layer, D) Neuron, E) Hidden layer, F) Class probability neuron (or corresponding pre-softmax neuron)"
-->

```{r units, fig.cap="特徴量の可視化は異なるユニットで行うことができる。A)畳み込みニューロン、B)畳み込みチャンネル、C)畳み込み層、D)ニューロン、E)隠れ層、F)クラス確率を示すニューロン(または、それに対応するソフトマックスの前のニューロン)", out.width=800}
knitr::include_graphics("images/units.jpg")
```

<!--
fig.cap="Optimized images for Inception V1 (channels mixed3a, mixed4c, mixed4d and mixed5a). Images are maximized for a random direction of the activations. Figure from Olah, et al. 2017 (CC-BY 4.0) https://distill.pub/2017/feature-visualization/."
-->

```{r trippy, fig.cap="Inception V1 で最適化された画像(mixed3a, mixed4c, mixed4d, mixed5a  チャンネル)。画像は、活性化のランダムな方向に対して最大化されている。Olah, et al. 2017 (CC-BY 4.0) https://distill.pub/2017/feature-visualization/", out.width=800, include = FALSE}
knitr::include_graphics("images/trippy.png")
```
#### 最適化を通した特徴量の可視化
<!--#### Feature Visualization through Optimization-->
<!--
In mathematical terms, feature visualization is an optimization problem.
We assume that the weights of the neural network are fixed, which means that the network is trained.
We are looking for a new image that maximizes the (mean) activation of a unit, here a single neuron:-->
数学的な観点では、特徴量の可視化は最適化問題になります。
ニューラルネットワークの重みが固定されていると仮定します。これはネットワークが学習済みであることを意味します。
ユニット、ここでは1つのニューロンを指しますが、の活性化関数の計算結果(の平均)を最大化する新しい画像を探します。

$$img^*=\arg\max_{img}h_{n,x,y,z}(img)$$

<!--The function $h$ is the activation of a neuron, *img* the input of the network (an image), x and y describe the spatial position of the neuron, n specifies the layer and z is the channel index.
For the mean activation of an entire channel z in layer n we maximize:-->
関数 $h$ はニューロンの活性化関数、*img* はネットワークの入力(画像)、x と y はニューロンの空間的な位置を表していて、n は層を特定し、z はチャンネルのインデックスです。
層 n のチャンネル z の全体の活性化関数の計算結果の平均を最大化するには次式のようにします。

$$img^*=\arg\max_{img}\sum_{x,y}h_{n,x,y,z}(img)$$

<!--In this formula, all neurons in channel z are equally weighted.
Alternatively, you can also maximize random directions, which means that the neurons would be multiplied by different parameters, including negative directions.
In this way, we study how the neurons interact within the channel.
Instead of maximizing the activation, you can also minimize the activation (which corresponds to maximizing the negative direction).
Interestingly, when you maximize the negative direction you get very different features for the same unit:-->
この方程式では、チャンネル z のすべてのニューロンが等しく重み付けされています。
あるいは、ランダムな方向に最大化できて、これはニューロンが負の方向を含む様々なパラメータをかけられることを意味します。
このようにして、ニューロンがチャンネルにどのように作用するかを学びます。
活性化関数を最大化するかわりに、最小化もできます(これは負の方向に最大化することに相当します)。
面白いことに、負の方向に最大化すると同じユニットでも全く異なる特徴量が得られます。

<!--```{r pos-neg, fig.cap="Positive (left) and negative (right) activation of Inception V1 neuron 484 from layer mixed4d pre relu. While the neuron is maximally activated by wheels, something which seems to have eyes yields a negative activation. Code: https://colab.research.google.com/github/tensorflow/lucid/blob/master/notebooks/feature-visualization/negative_neurons.ipynb", out.width=800}
knitr::include_graphics("images/a484.png")
```
-->
```{r pos-neg, fig.cap="Inception V1 の、ReLU の前の mixed4d 層のニューロン484 の正(左)と負(右)の活性化関数の値。ニューロンは車輪で最大に活性化されている一方、目を持つようなものが負の活性化を産んでいます。コード: https://colab.research.google.com/github/tensorflow/lucid/blob/master/notebooks/feature-visualization/negative_neurons.ipynb", out.width=800}
knitr::include_graphics("images/a484.png")
```

<!-- Why not use training data? -->
<!--We can address this optimization problem in different ways.
First, why should we generate new images?
We could simply search through our training images and select those that maximize the activation.-->
<!-- 学習データを使用してみませんか？ -->
この最適化問題に異なる方法で取り組むことができます。
はじめに、なぜ新しい画像を作るべきなのでしょうか。
単純に学習する画像を検索して、活性化関数を最大化するもの選ぶこともできます。

<!--This is a valid approach, but using training data has the problem that elements on the images can be correlated and we can't see what the neural network is really looking for.
If images that yield a high activation of a certain channel show a dog and a tennis ball, we don't know whether the neural network looks at the dog, the tennis ball or maybe at both.-->
これは有効なアプローチですが、学習データを使うことは画像の要素が一致してしまい、ニューラルネットが本当に探しているものがわからなくなるという問題があります。
もしある特定のチャンネルをよく活性化させる画像が犬やテニスボールを示していたら、ニューラルネットワークが犬を見ているのか、テニスボールを見ているのか、はたまた両方を見ているのかわかりません。

<!-- Direct optimization --> 
<!--The other approach is to generate new images, starting from random noise.
To obtain meaningful visualizations, there are usually constraints on the image, e.g. that only small changes are allowed.
To reduce noise in the feature visualization, you can apply jittering, rotation or scaling to the image before the optimization step.
Other regularization options include frequency penalization (e.g. reduce variance of neighboring pixels) or generating images with learned priors, e.g. with generative adversarial networks (GANs) [^synthesize] or denoising autoencoders [^plugandplay].-->
<!-- 直接最適化 --> 
別のアプローチはランダムなノイズから始めて新しい画像を生成することです。
意味のある可視化を得るために、例えば少しの変化しか許容しないなど、たいてい画像に対する制約があります。
特徴量の可視化のノイズを減らすために、最適化のステップの前に摂動、回転やスケーリングを画像に適用することもあります。
他の正則化の選択肢には、周波数が高いところのペナルティ化 (近い画素の分散を減らす など)、 または、 学習されたプライアーから画像を生成する手法 (generative adversarial network(GAN) [^synthesize], denoising autoencoder [^plugandplay] など) があります。

<!--```{r activation-optim, fig.cap="Iterative optimization from random image to maximizing activation. Olah, et al. 2017 (CC-BY 4.0) https://distill.pub/2017/feature-visualization/.", out.width=800}
knitr::include_graphics("images/activation-optim.png")
```
-->
```{r activation-optim, fig.cap="ランダムな画像による活性化関数を最大化する反復的な最適化。Olah, et al. 2017 (CC-BY 4.0) https://distill.pub/2017/feature-visualization/.", out.width=800}
knitr::include_graphics("images/activation-optim.png")
```
<!--
If you want to dive a lot deeper into feature visualization, take a look at the distill.pub online journal, especially the feature visualization post by Olah et al. [^distill-fv], from which I used many of the images, and also about the building blocks of interpretability [^distill-blocks].-->
もし特徴量の可視化にもっと深く潜りたいなら、オンラインの論文誌 distill.pub、特に、私が画像を多く引用した Olah らによる特徴量可視化の投稿 [^distill-fv] や説明可能なブロックの構成に関するもの [^distill-blocks] を見てみてください。

#### 敵対的サンプルとの繋がり
<!--#### Connection to Adversarial Examples-->
<!--
There is a connection between feature visualization and [adversarial examples](#adversarial):
Both techniques maximize the activation of a neural network unit.
For adversarial examples, we look for the maximum activation of the neuron for the adversarial (= incorrect) class.
One difference is the image we start with:
For adversarial examples, it is the image for which we want to generate the adversarial image.
For feature visualization it is, depending on the approach, random noise.-->
特徴量の可視化と[敵対的サンプル](#adversarial)には繋がりがあります。
両者の技術はニューラルネットワークのユニットの活性化を最大化します。
敵対的サンプルでは、敵対的な(間違った)クラスへのニューロンの最大活性化を探しました。
1つの違いは、スタート時の画像です: 
敵対的サンプルでは、敵対的な画像を生成しようとした画像です。
特徴量の可視化では、アプローチによっては、ランダムノイズです。

#### テキストおよび表形式データ
<!--#### Text and Tabular Data-->

<!--The literature focuses on feature visualization for convolutional neural networks for image recognition.
Technically, there is nothing to stop you from finding the input that maximally activates a neuron of a fully connected neural network for tabular data or a recurrent neural network for text data.
You might not call it feature visualization any longer, since the "feature" would be a tabular data input or text.
For credit default prediction, the inputs might be the number of prior credits, number of mobile contracts, address and dozens of other features.
The learned feature of a neuron would then be a certain combination of the dozens of features.
For recurrent neural networks, it is a bit nicer to visualize what the network learned:
Karpathy et. al (2015)[^viz-rnn] showed that recurrent neural networks indeed have neurons that learn interpretable features.
They trained a character-level model, which predicts the next character in the sequence from the previous characters.
Once an opening brace "(" occurred, one of the neurons got highly activated, and got de-activated when the matching closing bracket ")" occurred.
Other neurons fired at the end of a line.
Some neurons fired in URLs.
The difference to the feature visualization for CNNs is that the examples were not found through optimization, but by studying neuron activations in the training data.-->
ここでは、画像認識のための畳み込みニューラルネットワークの特徴量の可視化に焦点を当てます。技術的には、表形式データの為の全結合型ニューラルネットワークやテキストデータの為の再帰型ニューラルネットワークのニューロンを最大限活性化する入力を探すのにも何の支障もありません。
債務不履行予測では、入力は事前の信用の数値、携帯電話の契約数、住所やそのほか数十もの特徴量になるかもしれません。
ニューロンの学習された特徴量はその場合、数十の特徴量のいくつかの組み合わせになるでしょう。
再帰型ニューラルネットワークでは、ネットワークが学習したものは少しだけマシなものになるでしょう。
Karpathy et. al (2015)[^viz-rnn] は再帰型ニューラルネットワークが実際にニューロンが説明可能な特徴量を学習することを示しました。
彼らは文字列において前の文字から次の文字を予測するという、文字レベルのモデルを訓練しました。
括弧開き "("" が現れると、ニューロンの1つが強く活性化され、対応する括弧閉じ ")"が現れたときに不活性化しました。
他のニューロンは行の終端で活性化しました。
URLで活性化するニューロンもありました。
CNNの特徴量の可視化との違いは、そのような例が最適化を通じてではなく、学習データへのニューロン活性化を調査することで見つかったことです。

<!--Some of the images seem to show well-known concepts like dog snouts or buildings.
But how can we be sure?
The Network Dissection method links human concepts with individual neural network units.
Spoiler alert: Network Dissection requires extra datasets that someone has labeled with human concepts.-->
いくつかの画像は、犬の鼻や建物といった周知の概念を表すように見えます。
しかし、どのように確信できるのでしょうか。
ネットワーク解剖の手法は人間の理解とニューラルネットワークの個別のユニットを結びつけます。
ネタバレ注意: ネットワーク解剖では、誰かが人間の理解によってラベル付けした追加のデータセットが必要となります。

### ネットワークの解剖
<!--### Network Dissection {#network-dissection}-->

<!--The Network Dissection approach by Bau & Zhou et al. (2017) [^dissect] quantifies the interpretability of a unit of a convolutional neural network.
It links highly activated areas of CNN channels with human concepts (objects, parts, textures, colors, ...).
-->
Bau と Zhou ら(2017)[^dissect] による「ネットワークの解剖」の手法によって畳み込みニューラルネットワークのユニットの解釈性が定量化されました。
CNN チャンネルの大きく活性化している領域を人間の概念(物体、経路、模様、色...)で結びつけました。

<!--The channels of a convolutional neural network learn new features, as we saw in the chapter on [Feature Visualization](#feature-visualization).
But these visualizations do not prove that a unit has learned a certain concept.
We also do not have a measure for how well a unit detects e.g. sky scrapers.
Before we go into the details of Network Dissection, we have to talk about the big hypothesis that is behind that line of research.
The hypothesis is:
Units of a neural network (like convolutional channels) learn disentangled concepts.-->
[特徴量の可視化](#feature-visualization) の章で見たように、畳み込みニューラルネットワークのチャンネルは新たな特徴量を学習します。
しかしこの可視化はあるユニットがある特定の概念を学習したということではありません。
あるユニットが例えば摩天楼をどれくらいよく検出しているかを測る方法もありません。
ネットワークの解剖の詳細に向かう前に、その研究の主題の前にある大きな仮説について話さなければなりません。
その仮説とは:
(畳み込みチャンネルのような)ニューラルネットワークのあるユニットは解きほぐされた概念を学習する事です。

**解きほぐされた特徴量の問題**
<!--**The Question of Disentangled Features**-->

<!--Do (convolutional) neural networks learn disentangled features?
Disentangled features mean that individual network units detect specific real world concepts.
Convolutional channel 394 might detect sky scrapers, channel 121 dog snouts, channel 12 stripes at 30 degree angle ...
The opposite of a disentangled network is a completely entangled network.
In a completely entangled network, for example, there would be no individual unit for dog snouts.
All channels would contribute to the recognition of dog snouts.-->
(畳み込み)ニューラルネットワークは解きほぐされた特徴量を学習するのでしょうか？
解きほぐされた特徴量とはネットワークの個々のユニットが現実世界の特定の概念を
検出することを意味します。
畳み込みチャンネル394は摩天楼を検出し、チャンネル121はイヌの鼻を検出し、チャンネル12は30度の角度で縞をつける...などです。
解きほぐされたネットワークの反対は完全にもつれたネットワークです。
完全にもつれたネットワークでは、例えば、イヌの鼻を検出する個々のユニットはないでしょう。
すべてのチャンネルがイヌの鼻の認識に役立っています。

<!--Disentangled features imply that the network is highly interpretable.
Let us assume we have a network with completely disentangled units that are labeled  with known concepts.
This would open up the possibility to track the network's decision making process.
For example, we could analyze how the network classifies wolves against huskeys.
First, we identify the "huskey"-unit.
We can check whether this unit depends on the "dog snout", "fluffy fur" and "snow"-units from the previous layer.
If it does, we know that it will misclassify an image of a huskey with a snowy background as a wolf.
In a disentangled network, we could identify problematic non-causal correlations.
We could automatically list all highly activated units and their concepts to explain an individual prediction.
We could easily detect bias in the neural network.
For example, did the network learn a "white skin" feature to predict salary?

Spoiler-alert: Convolutional neural networks are not perfectly disentangled.
We will now look more closely at Network Dissection to find out how interpretable neural networks are.-->
特徴量が解きほぐされていることはネットワークがよく説明できることを示しています。
知っている概念でラベル付けされた完全に解きほぐされたユニットをもつネットワークを感得てみましょう。
これによってネットワークの決定がなされる過程を追跡できる可能性を広がります。
例えば、ネットワークがどのようにオオカミとハスキーを分離しているかを解析できます。
はじめに、「ハスキーの」ユニットを特定します。
そしてそのユニットが前の層から「イヌの鼻」「ふわふわな毛皮」「雪」のユニットのうちどれに依存しているかを確認します。
そうすれば、そのネットワークが雪の背景のハスキーの画像をオオカミと間違って分類してしまうことがわかるでしょう。
解きほぐされたネットワークでは、問題がある何気なくない相関を特定できます。
それぞれの予測を説明するためによく活性化しているユニットとそれが何の概念についてかをすべて自動的にリストアップできます。
そのニューラルネットワークの傾向を簡単に探すことができます。
例えば、給料を予測するためにネットワークが「白い肌」の特徴量を学習するでしょうか。

ネタバレ注意: 畳み込みニューラルネットワークは完全に解きほぐされているわけではありません。説明可能なニューラルネットワークがどんなものであるか見るためにネットワークの解剖についてより詳しく見ていきましょう。

#### ネットワークの解剖のアルゴリズム
<!--#### Network Dissection Algorithm-->

<!--Network Dissection has three steps: 

1. Get images with human-labeled visual concepts, from stripes to skyscrapers.
1. Measure the CNN channel activations for these images.
1. Quantify the alignment of activations and labeled concepts.-->

ネットワークの解剖は3つのステップからなっています。

1. 縞から摩天楼まで人間がラベル付けした視覚的な概念を持つ画像を入手します
2. それらの画像に対する CNN チャンネルの活性化度合いを計測します
3. 活性化度合いとラベル付けされた概念の組み合わせを定量化します

<!--The following figure visualizes how an image is forwarded to a channel and matched with the labeled concepts.
-->

次の画像はある画像がどうチャンネルに進んでいってラベル付けされた概念と一致するかを可視化したものです。

<!--
fig.cap = "For a given input image and a trained network (fixed weights), we forward propagate the image up to the target layer, upscale the activations to match the original image size and compare the maximum activations with the ground truth pixel-wise segmentation. Figure originally from Bau & Zhou et. al (2017)."
-->

```{r fig.cap = "与えられた画像と学習済みのネットワーク(重みが固定化されている)に対して、画像をターゲット層まで順伝搬して、活性化層の出力を元の画像サイズに合うようにスケールアップさせ、ground truth の pixel-wise セグメンテーションと活性化関数の最大値を比較しました。図は Bau と Zhou ら(2017)のものの引用です。", out.width=800}
knitr::include_graphics("images/dissection-network.png") 
```

**ステップ 1: Broden データセット** 
<!-- **Step 1: Broden dataset** -->

<!--
The first difficult but crucial step is data collection.
Network Dissection requires pixel-wise labeled images with concepts of different abstraction levels (from colors to street scenes).
Bau & Zhou et. al combined a couple of datasets with pixel-wise concepts.
They called this new dataset 'Broden', which stands for broadly and densely labeled data.
The Broden dataset is segmented to the pixel level mostly, for some datasets the whole image is labeled.
Broden contains 60,000 images with over 1,000 visual concepts in different abstraction levels: 468 scenes, 585 objects, 234 parts, 32 materials, 47 textures and 11 colors.
The following figure shows sample images from the Broden dataset.
-->
最初の困難だが重大なステップは、データ収集です。
ネットワーク解剖は、(色から街路の光景までのような)異なる抽象化レベルの概念によってピクセル単位でラベル付けされた画像を必要とします。
Bau & Zhou らは、いくつかのデータセットをピクセル単位の概念と結びつけました。
彼らはこの新たなデータセットを、広範(broadly)かつ稠密(densely)にラベル付けされたデータであることを表して ‘Broden’ と呼びました。
Broden データセットは殆どピクセルレベルまで断片化されており、一部のデータセットでは画像全体でラベル付けされています。
Broden は 60,000 枚の画像と、異なる抽象化レベルにおける 1,000 以上の視覚概念を含んでいます: 468の場面、585の物体、234の部品、32の物質、47の質感、11の色です。
次の画像では Broden データセットの幾つかのサンプル画像を示しています。

<!--
fig.cap = "Example images from the Broden dataset. Figure originally from Bau & Zhou et. al (2017)."
-->

```{r fig.cap = "Broden データセットからの画像例。オリジナルは Bau & Zhou et. al (2017) によるもの。", out.width=800}
knitr::include_graphics("images/broden.png")
```

**ステップ 2: ネットワークの活性化を読み出す**
<!--**Step 2: Retrieve network activations**-->

<!--Next, we create the masks of the top activated areas per channel and per image.
At this point the concept labels are not yet involved.-->
次に、チャンネルごとおよび画像ごとに最も活性化している領域のマスクを作成します。
この時点では、概念ラベルはまだ関係ありません。

<!--
- For each convolutional channel k:
    - For each image x in the Broden dataset
        - Forward propagate image x to the target layer containing channel k.
        - Extract the pixel activations of convolutional channel k: $A_k(x)$
    - Calculate distribution of pixel activations $\alpha_k$ over all images
    - Determine the 0.005-quantile level $T_k$ of activations $\alpha_k$. This means 0.5% of all activations of channel k for image x are greater than $T_k$.
    - For each image x in the Broden dataset:
        - Scale the (possibly) lower-resolution activation map $A_k(x)$ to the resolution of image x. We call the result $S_k(x)$.
        - Binarize the activation map: A pixel is either on or off, depending on whether it exceeds the activation threshold $T_k$. The new mask is $M_k(x)=S_k(x)\geq{}T_k(x)$.
-->
- それぞれの畳み込みチャンネル k について:
    - Broden データセット内のそれぞれの画像 x について
        - チャンネル k を含む目的の層への、画像 x の順伝播
        - 畳み込みチャンネル k のピクセル活性化の抽出: $A_k(x)$
    - 画像全体にわたるピクセル活性化 $\alpha_k$ の分布計算
    - 活性化 $\alpha_k$ の0.005-分位点 $T_k$ の決定。これは画像 x に対するチャンネル k の全活性化のうち 0.5% は $T_k$ よりも大きいことを意味します。
    - Broden データセット内のそれぞれの画像 x について:
        - (場合によっては)低解像度の activation map $A_k(x)$ を画像 x の解像度にまで拡大します。この結果を $S_k(x)$ と呼びます。
        - その activation map を二値化: 活性化閾値 $T_k$ を超えるか否かにより、ピクセルがオンかオフになります。この新しいマスクを $M_k(x)=S_k(x)\geq{}T_k(x)$ とします。

**ステップ 3: 活性化概念の団結**
<!--**Step 3: Activation-concept alignment**-->
<!--
After step 2 we have one activation mask per channel and image.
These activation masks mark highly activated areas.
For each channel we want to find the human concept that activates that channel.
We find the concept by comparing the activation masks with all labeled concepts.
We quantify the alignment between activation mask k and concept mask c with the Intersection over Union (IoU) score:
-->
ステップ 2により、チャンネルおよび画像ごとに1つの活性化マスクを得ました。
これらの活性化マスクは強く活性化された領域を印付けます。
各チャンネルについて、チャンネルを活性化する人間的な概念を見つけたいです。
活性化マスクと全てのラベル付けされたコンセプトを比較することで、概念を発見します。
活性化マスク k と概念マスク c の間の団結を Intersection over Union (IoU) スコアにより定量化します。

<!--
$$IoU_{k,c}=\frac{\sum|M_k(x)\bigcap{}L_c(x)|}{\sum|M_k(x)\bigcup{}L_c(x)|}$$
-->
$$IoU_{k,c}=\frac{\sum|M_k(x)\bigcap{}L_c(x)|}{\sum|M_k(x)\bigcup{}L_c(x)|}$$

<!--
where $|\cdot|$ is the cardinality of a set.
Intersection over union compares the alignment between two areas.
$IoU_{k,c}$ can be interpreted as the accuracy with which unit k detects concept c.
We call unit k a detector of concept c when $IoU_{k,c}>0.04$. 
This threshold was chosen by Bau & Zhou et. al.
-->
ここで $|\cdot|$ は集合の濃度です。
IoU は2つの領域の団結を比較します。
$IoU_{k,c}$ は、ユニット k が概念 c を検出する精度として解釈できます。
$IoU_{k,c}>0.04$ のときにユニット k を概念 c の検出器と呼ぶことにします。

<!--
The following figure illustrates intersection and union of activation mask and concept mask for a single image:
-->
次の図は1枚の画像に対する活性化マスクと概念マスクの IoU を説明しています。

<!--
fig.cap = "The Intersection over Union (IoU) is computed by comparing the human ground truth annotation and the top activated pixels."
-->

```{r, fig.cap = "人間がつけた正解アノテーションと最上位活性化ピクセルを比較して計算された Intersection over Union (IoU)。", out.width=800}
knitr::include_graphics("images/dissection-dog-exemplary.jpg")
```
<!--
The following figure shows a unit that detects dogs:
-->
次の図は犬を検出するユニットを見せています。

<!--
fig.cap = "Activation mask for inception_4e channel 750 which detects dogs with $IoU=0.203$. Figure originally from Bau & Zhou et. al (2017)."
-->

```{r, fig.cap = "$IoU=0.203$ で犬を検出する inception_4e のチャンネル 750 の活性化マスク。オリジナルは Bau & Zhou et. al (2017) によるもの。", out.width=800}
knitr::include_graphics("images/dissection-dogs.jpeg")
```

#### 実験
<!--#### Experiments-->
<!--
The Network Dissection authors trained different network architectures (AlexNet, VGG, GoogleNet, ResNet) from scratch on different datasets (ImageNet, Places205, Places365).
ImageNet contains 1.6 million images from 1000 classes that focus on objects.
Places205 and Places365 contain 2.4 million / 1.6 million images from 205 / 365 different scenes.
They additionally trained AlexNet on self-supervised training tasks such as predicting video frame order or colorizing images.
For many of these different settings, they counted the number of unique concept detectors as a measure of interpretability.
Here are some of the findings:
-->
ネットワーク解析者達は様々なネットワーク構造 (AlexNet, VGG, GoogleNet, ResNet)を異なるデータセット(ImageNet, Places205, Places365)を用いて訓練しました。
ImageNet は物体に焦点をおいた1000のクラスの160万枚の画像を含んでいます。
Places205とPlaces365は205/365の異なるシーンからの画像240/160万枚の画像を含んでいいます。
彼らは追加で AlexNet をビデオフレームの順序や画像の色付けなどの自己管理型のタスクについて訓練しました。
これらの多くの異なる設定において、彼らは、解釈性の尺度として、unique concept detectors の数を数えました。
下記の物がいくつかの発見です。

<!--
- The networks detect lower-level concepts (colors, textures) at lower layers and higher-level concepts (parts, objects) at higher layers.
  We have already seen this in the [Feature Visualizations](#feature-visualization).
- Batch normalization reduces the number of unique concept detectors.
- Many units detect the same concept.
For example, there are 95 (!) dog channels in VGG trained on ImageNet when using $IoU \geq 0.04$ as detection cutoff (4 in conv4_3, 91 in conv5_3, see [project website](http://netdissect.csail.mit.edu/dissect/vgg16_imagenet/)).
- Increasing the number of channels in a layer increases the number of interpretable units.
- Random initializations (training with different random seeds) result in slightly different numbers of interpretable units.
- ResNet is the network architecture with the largest number of unique detectors, followed by VGG, GoogleNet and AlexNet last.
- The largest number of  unique concept detectors are learned for Places356, followed by Places205 and ImageNet last.
- The number of unique concept detectors increases with the number of training iterations.-->

- ネットワークは下の層で下位レベルの概念（色、テクスチャー）を検知し、上層で上位の概念を検知します（パーツ、物体）。
私たちは既にこれについて特徴量視覚化で学んでいます(#feature-visualization)。
- バッチ正規化により、unique concept detectors の数を減らします。
- 多くのユニットは同じ概念を検知します。
例えば、 $IoU \geq 0.04$ を検知のカットオフとして使用した場合、ImageNet で訓練された VGG には 95（！）の犬のチャンネルがあります。
- 層の中のチャンネルの数を増やせば、解釈可能なユニットの数も増えます。
- ランダムな初期化の使用によって（異なるランダムシードと共に訓練すること）少しだけ異なる数の解釈可能なユニットに行き着くことがあります。
- Places356 で最も多くの unique concept detectors が学ばれ、次に Places205 と ImageNet が続きます。

<!--
fig.cap = "ResNet trained on Places365 has the highest number of unique detectors. AlexNet with random weights has the lowest number of unique detectors and serves as baseline. Figure originally from Bau & Zhou et. al (2017)."
-->

```{r fig.cap = "Places365で訓練されたResNetga一番多くのunique detectorsを持ちます。ランダムな重みを持つAlexNetが最も少ないunique detectorsの数を持ちベースラインの役割を果たします。. 画像は Bau & Zhou et. al (2017)からの出典です。"}
knitr::include_graphics("images/arch-compare.png")
```

<!--
- Networks trained on self-supervised tasks have fewer unique detectors compared to networks trained on supervised tasks.
- In transfer learning, the concept of a channel can change. For example, a dog detector became a waterfall detector. This happened in a model that was initially trained to classify objects and then fine-tuned to classify scenes.
- In one of the experiments, the authors projected the channels onto a new rotated basis.
This was done for the VGG network trained on ImageNet.
"Rotated" does not mean that the image was rotated.
"Rotated" means that we take the 256 channels from the conv5 layer and compute new 256 channels as linear combinations of the original channels.
In the process, the channels get entangled.
Rotation reduces interpretability, i.e., the number of channels aligned with a concept decreases.
The rotation was designed to keep the performance of the model the same.
The first conclusion:
Interpretability of CNNs is axis-dependent.
This means that random combinations of channels are less likely to detect unique concepts.
The second conclusion:
 Interpretability is independent of discriminative power.
 The channels can be transformed with orthogonal transformations while the discriminative power remains the same, but interpretability decreases. 
 -->

- 自己管理タスクで訓練されたネットワークは教師ありタスクで訓練されたネットワークと比べて少ない unique detectors を持ちます。
- 転移学習において、チャンネルの概念は変わります。例えば、犬の検知器は滝の検知器になりました。これは、最初、物体を分類するためのモデルを fine-tuning を使い、シーンを分類するためのモデルに変更しようとした時に起こりました。
- 実験のひとつで、著者は、チャンネルを新しいローテーション基底に投影しました。
これは ImageNet で訓練された VGG ネットワークで行われました。
"ローテーション"は画像が回転することを意味しているのではありません。
"ローテーション"は、私たちは画像の conv5層から 256 のチャンネルを取得し、元のチャンネルの線形結合として新たな 256 のチャンネルを計算することを意味します。
この過程で、チャンネルはかみ合います。
ローテーションは解釈性を減少させます。ex.概念に沿った、チャンネルの数が減少します。
ローテーションはモデルの性能を同じに保つために設計されました。
最初の結論は、「CNN の解釈性は軸に依存する」です。
これは、ランダムな組み合わせのチャンネルが unique concepts を検知する確率が低いことを意味します。
2つ目の結論は、「解釈性は識別力とは無関係」です。
チャンネルは直交変換で識別力を保ったまま変換できますが、解釈性は減少します。

<!--
fig.cap = "The number of unique concept detectors decreases when the 256 channels of AlexNet conv5 (trained on ImageNet) are gradually changed to a basis using a random orthogonal transformation. Figure originally from Bau & Zhou et. al (2017)."
-->

```{r fig.cap = "AlexNet,conv5（ImageNetで学習済み）の256のチャンネルがランダムな直交変換を使用して徐々に変更されると、unique concept detectorsの数は減少します 画像は Bau & Zhou et. al (2017).からの出典です。"}
knitr::include_graphics("images/rotation-dissect.png")
```

<!--
The authors also used Network Dissection for Generative Adversarial Networks (GANs).
You can find Network Dissection for GANs on [the project's website](https://gandissect.csail.mit.edu/).
-->
著者は GAN (Generative Adversarial Networks) に対してもネットワーク解剖を行なっています。
GAN に対するネットワーク解剖は、こちらの[webサイト]((https://gandissect.csail.mit.edu/)をご覧ください。

### 利点
<!--### Advantages-->
<!--
Feature visualizations give **unique insight into the working of neural networks**, especially for image recognition.
Given the complexity and opacity of neural networks, feature visualization is an important step in analyzing and describing neural networks.
Through feature visualization, we have learned that neural networks first learn simple edge and texture detectors and more abstract part and object detectors in higher layers.
Network dissection expands those insights and makes interpretability of network units measurable.

Network dissection allows us to **automatically link units to concepts**, which is very convenient.

Feature visualization is a great tool to **communicate in a non-technical way how neural networks work**.

With network dissection, we can also **detect concepts beyond the classes in the classification task**.
But we need datasets that contain images with pixel-wise labeled concepts.

Feature visualization can be **combined with feature attribution methods**, which explain which pixels were important for the classification.
The combination of both methods allows to explain an individual classification along with local visualization of the learned features that were involved in the classification.
See [The Building Blocks of Interpretability from distill.pub](https://distill.pub/2018/building-blocks/).

Finally, feature visualizations make **great desktop wallpapers and T-Shirts prints**.
-->
特徴量視覚化は、特に画像認識において、**ニューラルネットワークの働きに対してユニークな視点**を与えます。
ニューラルネットワークの複雑性と不透明性において、特徴量の視覚化はニューラルネットワークを分析、説明するための重要な一歩です。
特徴量視覚化を通して、ニューラルネットワークは最初にシンプルなエッジやテクスチャを検知し、次にもっと抽象的な部分、そして最後に物体検知の層になっていることがわかりました。
ネットワーク分析はこれらの洞察を拡大し、ネットワークユニットの解釈性を測定可能なものにします。
ネットワーク分析は、私たちに「概念を自動的にユニットとリンクさせること」を許します。これはとても便利です。
特徴量視覚化は、**ニューラルネットワークがどのように動いているかを非技術的な方法で伝えるための素晴らしい手法です。
ネットワーク分析と共に、**分類のタスクにおいてクラスを超えた概念**を検知できます。
しかし、私たちはピクセル単位でラベル付けされた概念を持つ画像のデータセットが必要です。

### 欠点
<!--### Disadvantages-->
<!--
**Many feature visualization images are not interpretable** at all, but contain some abstract features for which we have no words or mental concept.
  The display of feature visualizations along with training data can help.
 The images still might not reveal what the neural network reacted to and only show something like "maybe there has to be something yellow in the images".
Even with Network Dissection some channels are not linked to a human concept.
For example, layer conv5_3 from VGG trained on ImageNet has 193 channels (out of 512) that could not be matched with a human concept.
-->
**多くの特徴量可視化画像は全く解釈可能ではありません**が、それを表す言葉や精神的概念が存在しないような、いくつかの抽象的な特徴量を含んでいます。
学習データと同時に特徴量可視化を表示することは、助けになります。
画像はニューラルネットワークが何に反応し、"画像に何か黄色い部分があるはずだ"といったことだけを示すのかまでは、明らかにしないかもしれません。
ネットワーク解剖によっても、人間的な概念と結び付けられないチャンネルがあります。
例えば、ImageNet で訓練された VGG の conv5_3 層は(512のうち)193のチャンネルは人間的な概念と組み合わせられませんでした。

<!--
There are **too many units to look at**, even when "only" visualizing the channel activations.
  For Inception V1 there are already over 5000 channels from 9 convolutional layers.
If you also want to show the negative activations plus a few images from the training data that maximally or minimally activate the channel (let's say 4 positive, 4 negative images), then you must already display more than 50 000 images.
At least we know -- thanks to Network Dissection -- that we do not need to investigate random directions.
 -->
チャンネルのアクティブ化「のみ」を視覚化する場合でも、**見るユニットが多くなりすぎます**。
Inception V1 の場合、既に 5000 を超えるチャンネルが9つの畳み込み層からあります。
さらに負の活性化に加え、チャンネルを最大または最小に活性化する学習データからのいくつかの画像（例えば、4つの正、4つの負の画像）も表示する場合は、50000 を超える画像を表示する必要があります。
少なくとも、ネットワーク解剖のおかげで、ランダムな方向を調査する必要がないことは分かっています。

<!--
**Illusion of Interpretability?**
  The feature visualizations can convey the illusion that we understand what the neural network is doing.
  But do we really understand what is going on in the neural network?
  Even if we look at hundreds or thousands of feature visualizations, we cannot understand the neural network.
  The channels interact in a complex way, positive and negative activations are unrelated, multiple neurons might learn very similar features and for many of the features we do not have equivalent human concepts.
  We must not fall into the trap of believing we fully understand neural networks just because we believe we saw that neuron 349 in layer 7 is activated by daisies.
  Network Dissection showed that architectures like ResNet or Inception have units that react to certain concepts.
  But the IoU is not that great and often many units respond to the same concept and some to no concept at all.
  They channels are not completely disentangled and we cannot interpret them in isolation.

For Network Dissection, **you need datasets that are labeled on the pixel level** with the concepts.
  These datasets take a lot of effort to collect, since each pixel needs to be labeled, which usually works by drawing segments around objects on the image.

Network Dissection only aligns human concepts with positive activations but not with negative activations of channels.
As the feature visualizations showed, negative activations seem to be linked to concepts.
This might be fixed by additionally looking at the lower quantile of activations.
 -->
**解釈可能の錯覚**
特徴の視覚化は、ニューラルネットワークが何をしているのかを理解しているという錯覚を私たちに伝える可能性があります。
しかし、ニューラルネットワークで何が起こっているのかを本当に理解していますか。
仮に数百または数千の特徴の視覚化を見ても、ニューラルネットワークは理解できません。
チャンネルは複雑な方法で相互作用し、正と負の活性化は無関係であり、複数のニューロンが非常に類似した機能を学習する可能性もあり、特徴の多くについては人間に同等の概念は存在しません。
レイヤー7のニューロン349がヒナギクによって活性化されるのを確認できたからといって、ニューラルネットワークを完全に理解していると信じる罠に陥ってはなりません。
Network Dissection は、ResNet や Inception のような設計には、特定の概念に反応するユニットがあることを示しました。
しかし、IoU はそれほど優れたものではなく、多くの場合、多くのユニットが同じ概念に反応し、一部のユニットはまったく概念に反応しません。
チャンネルは完全に解きほぐされておらず、単独で解釈できません。

ネットワーク解剖の場合、**ピクセルレベルでラベル付けされたデータセット**の概念が必要になります。
これらのデータセットは、各ピクセルにラベルを付ける必要があるため、収集に多大な労力を要します。これは通常、画像上の物体の周囲に境界線を引くことでなされます。

ネットワーク解剖は、人間の概念を正の活性化と一致させるだけであり、チャンネルの負の活性化とは一致させません。
特徴の視覚化が示したように、負の活性化は概念とリンクしているようです。
これは、活性化の下位分位数をさらに調べることで修正される可能性があります。

### ソフトウェアとその他の資料
<!--### Software and Further Material -->

<!--
There is an open-source implementation of feature visualization called [Lucid](https://github.com/tensorflow/lucid).
You can conveniently try it in your browser by using the notebook links that are provided on the Lucid Github page.
No additional software is required.
Other implementations are [tf_cnnvis](https://github.com/InFoCusp/tf_cnnvis) for TensorFlow, [Keras Filters](https://github.com/jacobgil/keras-filter-visualization) for Keras and [DeepVis](https://github.com/yosinski/deep-visualization-toolbox) for Caffe.

Network Dissection has a great [project website](http://netdissect.csail.mit.edu/).
Next to the publication, the website hosts additional material such as code, data and visualizations of activation masks.
-->
[Lucid](https://github.com/tensorflow/lucid)と呼ばれる特徴視覚化のオープンソース実装があります。
Lucid Github ページにあるノートブックのリンクから、ウェブブラウザ上で簡単に試すことができます。
追加のソフトウェアは必要ありません。
他には Tensorflow の [tf_cnnvis](https://github.com/InFoCusp/tf_cnnvis) 、Keras の[Keras Filters](https://github.com/jacobgil/keras-filter-visualization)、Caffe の[DeepVis](https://github.com/yosinski/deep-visualization-toolbox) で実装できます。
Network Dissection には素晴らしい[プロジェクトのウェブサイト](http://netdissect.csail.mit.edu/)があります。
ウェブサイトでは出版物の隣にコード、データ、活性化マスクなどが視覚化された追加資料がホストされています。

[^distill-fv]: Olah, et al., "Feature Visualization", Distill, 2017.

[^distill-blocks]: Olah, et al., "The Building Blocks of Interpretability", Distill, 2018.

[^plugandplay]: Nguyen, Anh, et al. "Plug & play generative networks: Conditional iterative generation of images in latent space." Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition. 2017.

[^synthesize]: Nguyen, Anh, et al. "Synthesizing the preferred inputs for neurons in neural networks via deep generator networks." Advances in Neural Information Processing Systems. 2016.

[^viz-rnn]: Karpathy, Andrej, Justin Johnson, and Li Fei-Fei. "Visualizing and understanding recurrent networks." arXiv preprint arXiv:1506.02078 (2015).

[^dissect]: Bau, David, et al. "Network dissection: Quantifying interpretability of deep visual representations." Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition. 2017.

[^imagenet]: Olga Russakovsky*, Jia Deng*, Hao Su, Jonathan Krause, Sanjeev Satheesh, Sean Ma, Zhiheng Huang, Andrej Karpathy, Aditya Khosla, Michael Bernstein, Alexander C. Berg and Li Fei-Fei. (* = equal contribution) ImageNet Large Scale Visual Recognition Challenge. IJCV, 2015

