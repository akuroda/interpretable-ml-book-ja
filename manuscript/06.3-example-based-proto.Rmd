```{r, message = FALSE, warning = FALSE, echo = FALSE}
devtools::load_all()
set.seed(42)
```

<!--{pagebreak}-->

## prototype と criticism {#proto}
<!--## Prototypes and Criticisms {#proto}-->

<!--
A **prototype** is a data instance that is representative of all the data.
A **criticism** is a data instance that is not well represented by the set of prototypes.
The purpose of criticisms is to provide insights together with prototypes, especially for data points which the prototypes do not represent well.
Prototypes and criticisms can be used independently from a machine learning model to describe the data, but they can also be used to create an interpretable model or to make a black box model interpretable.

In this chapter I use the expression "data point" to refer to a single instance, to emphasize the interpretation that an instance is also a point in a coordinate system where each feature is a dimension.
The following figure shows a simulated data distribution, with some of the instances chosen as prototypes and some as criticisms.
The small points are the data, the large points the criticisms and the large squares the prototypes.
The prototypes are selected (manually) to cover the centers of the data distribution and the criticisms are points in a cluster without a prototype.
Prototypes and criticisms are always actual instances from the data.
-->
**prototype** は、すべてのデータの代表であるデータインスタンスです。
**criticism** は prototype の集まりではうまく表現できないデータインスタンスです。
criticism の目的は、特に、prototype が良く表現できないデータ点について、prototype とともに見識を提供することです。
prototype と criticism は、データを記述するのに機械学習モデルとは独立に使用可能ですが、解釈可能なモデルを作成したり、ブラックボックスモデルを解釈可能にするために使用できます。

この章では、1つのインスタンスを指すときや、あるインスタンスはそれぞれの特徴量の次元である座標系における1つの点でもあることの説明を強調するために "データ点" という表現を使います。
次の図は、シミュレーションによるデータの分布を示していて、prototype として、または criticism として選択されたインスタンスもいくつかあります。
小さな点はデータ、大きな点は criticism で、大きな四角形は prototype です。
prototype はデータ分布の中央を覆うように(手動で)選択されていて、criticism は prototype を除くクラスタ内の点です。
prototype と criticism は常に実際のデータに含まれるインスタンスです。

<!--
fig.cap = "Prototypes and criticisms for a data distribution with two features x1 and x2."
-->

```{r, fig.cap = "2つの特徴量 x1 と x2 を持つデータ分布の prototype と criticism。"}
set.seed(1)
dat1 = data.frame(x1 = rnorm(20, mean = 4, sd = 0.3), x2 = rnorm(20, mean = 1, sd = 0.3))
dat2 = data.frame(x1 = rnorm(30, mean = 2, sd = 0.2), x2 = rnorm(30, mean = 2, sd = 0.2))
dat3 = data.frame(x1 = rnorm(40, mean = 3, sd = 0.2), x2 = rnorm(40, mean = 3))
dat4 = data.frame(x1 = rnorm(7, mean = 4, sd = 0.1), x2 = rnorm(7, mean = 2.5, sd = 0.1))

dat = rbind(dat1, dat2, dat3, dat4)
dat$type = "データ"
dat$type[c(7, 23, 77)] = "prototype"
dat$type[c(81,95)] = "criticism"

ggplot(dat, aes(x = x1, y = x2)) + geom_point(alpha = 0.7) +
  geom_point(data = filter(dat, type!='データ'), aes(shape = type), size = 9, alpha = 1, color = "blue") +
  scale_shape_manual(breaks = c("prototype", "criticism"), values = c(18, 19))

```

<!--
I selected the prototypes manually, which does not scale well and probably leads to poor results.
There are many approaches to find prototypes in the data.
One of these is k-medoids, a clustering algorithm related to the k-means algorithm.
Any clustering algorithm that returns actual data points as cluster centers would qualify for selecting prototypes.
But most of these methods find only prototypes, but no criticisms.
This chapter presents MMD-critic by Kim et. al (2016)[^critique], an approach that combines prototypes and criticisms in a single framework.
-->
手作業で prototype を選びましたが、これは上手くスケールせず悪い結果になりそうです。
データの中から prototype を見つけるためのアプローチはたくさんあります。
そのうちの1つが k-medoids であり、k-means アルゴリズムに関連するクラスタリングアルゴリズムです。
クラスタの中心として実際のデータ点を返すようなクラスタリングアルゴリズムであれば prototype の選択に適しているでしょう。
しかし、それらの手法の殆どは prototype しか見つけることができず、criticism は見つけられません。
この章では、Kim et.al (2016)[^critique] による MMD-critic という、prototype と criticism を1つのフレームワークに組み合わせたアプローチを紹介します。

<!--
MMD-critic compares the distribution of the data and the distribution of the selected prototypes.
This is the central concept for understanding the MMD-critic method.
MMD-critic selects prototypes that minimize the discrepancy between the two distributions.
Data points in areas with high density are good prototypes, especially when points are selected from different "data clusters".
Data points from regions that are not well explained  by the prototypes are selected as criticisms.

Let us delve deeper into the theory.
-->
MMD-critic は、データの分布と選択された prototype の分布を比較します。
これが MMD-critic を理解するための中心的な概念です。
MMD-critic は、2つの分布間の差異を最小化するような prototype を選択します。
密度の高い領域のデータ点、特に、異なる"データクラスタ"から選ばれたとき、良い prototype となります。
prototype ではうまく説明できない範囲から得られるデータ点は criticism として選択されます。

理論を深掘りしましょう。

<!--
### Theory
-->
### 理論

<!--
The MMD-critic procedure on a high-level can be summarized briefly:

1. Select the number of prototypes and criticisms you want to find.
1. Find prototypes with greedy search.
Prototypes are selected so that the distribution of the prototypes is close to the data distribution.
1. Find criticisms with greedy search.
Points are selected as criticisms where the distribution of prototypes differs from the distribution of the data.
-->
高レベルでの MMD-critic の手順は以下のように簡潔にまとめられます。

1. 見つけたい prototype と criticism の数を選びます。
1. prototype を貪欲法で探索します。
prototype の分布がデータの分布と近くなるように prototype は選択されます。
1. criticism を貪欲法で探索します。
prototype の分布とデータの分布が異なる点は criticism として選択されます。

<!--
We need a couple of ingredients to find prototypes and criticisms for a dataset with MMD-critic.
As the most basic ingredient, we need a **kernel function** to estimate the data densities.
A kernel is a function that weighs two data points according to their proximity.
Based on density estimates, we need a measure that tells us how different two distributions are so that we can determine whether the distribution of the prototypes we select is close to the data distribution.
This is solved by measuring the **maximum mean discrepancy (MMD)**.
Also based on the kernel function, we need the **witness function** to tell us how different two distributions are at a particular data point.
With the witness function, we can select criticisms, i.e. data points at which the distribution of prototypes and data diverges and the witness function takes on large absolute values.
The last ingredient is a search strategy for good prototypes and criticisms, which is solved with a simple **greedy search**.
-->
データセットにおける prototype と criticism を MMD-critic によって見つけるために必要な構成要素がいくつかあります。
最も基本的な要素として、データの密度を推定するために**カーネル関数**が必要です。
カーネルは2つのデータ点の近さに応じて重み付けする関数です。
密度推定に基づいて、選択された prototype の分布がデータの分布と近いかどうか知るために、2つの分布がどれだけ異なるのかを知る基準が必要です。
これは、 **maximum mean discrepancy(MMD)** を測ることで解決します。
また、カーネル関数に基づいて、特定のデータ点において2つの分布がどれだけ異なるのか知るための **witness 関数**が必要です。
prototype とデータの分布が乖離していて、witness 関数が大きな絶対値をとるデータ点を criticism として選択できます。
最後の要素は、良い prototype と criticism のための探索戦略であり、単に**貪欲探索**によって解決します。

<!--
Let us start with the **maximum mean discrepancy (MMD)**, which measures the discrepancy between two distributions.
The selection of prototypes creates a density distribution of prototypes.
We want to evaluate whether the prototypes distribution differs from the data distribution.
We estimate both with kernel density functions.
The maximum mean discrepancy measures the difference between two distributions, which is the supremum over a function space of differences between the expectations according to the two distributions.
All clear?
Personally, I understand these concepts much better when I see how something is calculated with data.
The following formula shows how to calculate the squared MMD measure (MMD2):
-->
2つの分布の違いを測る **maximum mean discrepancy(MMD)** から初めていきましょう。
prototype の選択によって prototype の密度分布を作ります。
我々は prototype の分布がデータの分布と異なるのかどうか評価したいです。
カーネル密度関数によってその両方を推定します。
maximum mean discrepancy は2つの分布間の差異を測る指標です。これは2つの分布に対応する期待値間の差異を表す関数空間上での上界です。
わかるでしょうか。
個人的に、これらの概念は、データからどんなものが計算されるのかを見た方が遥かに良く理解できます。
次の式は、MMD の二乗(MMD2)の計算方法を示しています。

$$MMD^2=\frac{1}{m^2}\sum_{i,j=1}^m{}k(z_i,z_j)-\frac{2}{mn}\sum_{i,j=1}^{m,n}k(z_i,x_j)+\frac{1}{n^2}\sum_{i,j=1}^n{}k(x_i,x_j)$$

<!--
k is a kernel function that measures the similarity of two points, but more about this later.
m is the number of prototypes z, and n is the number of data points x in our original dataset.
The prototypes z are a selection of data points x.
Each point is multidimensional, that is it can have multiple features.
The goal of MMD-critic is to minimize MMD2.
The closer MMD2 is to zero, the better the distribution of the prototypes fits the data.
The key to bringing MMD2 down to zero is the term in the middle, which calculates the average proximity between the prototypes and all other data points (multiplied by 2).
If this term adds up to the first term (the average proximity of the prototypes to each other) plus the last term (the average proximity of the data points to each other), then the prototypes explain the data perfectly.
Try out what would happen to the formula if you used all n data points as prototypes.
-->
k は2点の類似度を測るカーネル関数ですが、これについては後述します。
m は prototype である z の数で、n は元々のデータセット上のデータ点 x の数です。
prototype の z はデータ点 x から選ばれたものです。
それぞれの点は多次元なので、複数の特徴量を持つことができます。
MMD-critic の目的は MMD2 を最小化することです。
MMD2 がゼロに近いほど、prototype の分布はデータによくフィットします。
MMD2 をゼロに近づける鍵となるのは中央の項で、これは prototype と全てのデータ点との平均的な（2乗された）近さを計算します。
この項と、最初の項（prototype どうしの平均的な近さ）に加え、最後の項（データどうしの平均的な近さ）を足し上げれば、prototype はデータを完璧に説明できます。
n 個全てのデータ点を prototype として使った時、この式に何がどうなるのか試してみてください。


<!--
The following graphic illustrates the MMD2 measure.
The first plot shows the data points with two features, whereby the estimation of the data density is displayed with a shaded background.
Each of the other plots shows different selections of prototypes, along with the MMD2 measure in the plot titles.
The prototypes are the large dots and their distribution is shown as contour lines.
The selection of the prototypes that best covers the data in these scenarios (bottom left) has the lowest discrepancy value.
-->
次の図は、MMD2 measure を表現しています。
最初の図は、データ点を2つの特徴量で示していて、推定データ密度を背景にグラデーションで表現しています。
その他はそれぞれ異なる prototype の選択をしていて、その時の MMD2 measure を図の上部に記しています。
prototype は大きなドットで、その分布は等高線で表しています。
これらの中で最もデータを覆っている prototype の選択は（左下）最も低い乖離度になっています。


<!--
fig.cap = "The squared maximum mean discrepancy measure (MMD2) for a dataset with two features and different selections of prototypes."
-->

```{r mmd, fig.cap = "二つの特徴量を持つデータセットに対する異なる prototype の MMD の二乗(MMD2)", cache = FALSE}
set.seed(42)
n = 40
# create dataset from three gaussians in 2d
dt1 = data.frame(x1 = rnorm(n, mean = 1, sd = 0.1), x2 = rnorm(n, mean = 1, sd = 0.3))
dt2 = data.frame(x1 = rnorm(n, mean = 4, sd = 0.3), x2 = rnorm(n, mean = 2, sd = 0.3))
dt3 = data.frame(x1 = rnorm(n, mean = 3, sd = 0.5), x2 = rnorm(n, mean = 3, sd = 0.3))
dt4 = data.frame(x1 = rnorm(n, mean = 2.6, sd = 0.1), x2 = rnorm(n, mean = 1.7, sd = 0.1))
dt = rbind(dt1, dt2, dt3, dt4)


radial = function(x1, x2, sigma = 1) {
  dist = sum((x1 - x2)^2)
  exp(-dist/(2*sigma^2))
}


cross.kernel = function(d1, d2) {
  kk = c()
  for (i in 1:nrow(d1)) {
    for (j in 1:nrow(d2)) {
      res = radial(d1[i,], d2[j,])
      kk = c(kk, res)
    }
  }
  mean(kk)
}

mmd2 = function(d1, d2) {
  cross.kernel(d1, d1) - 2 * cross.kernel(d1, d2) + cross.kernel(d2,d2)
}

# create 3 variants of prototypes
pt1 = rbind(dt1[c(1,2),], dt4[1,])
pt2 = rbind(dt1[1,], dt2[3,], dt3[19,])
pt3 = rbind(dt2[3,], dt3[19,])

# create plot with all data and density estimation
p = ggplot(dt, aes(x = x1, y = x2)) +
  stat_density_2d(geom = "tile", aes(fill = ..density..), contour = FALSE, alpha = 0.9) +
  geom_point() +
  scale_fill_gradient2(low = "white", high = "blue", guide = "none") +
  scale_x_continuous(limits = c(0, NA)) +
  scale_y_continuous(limits = c(0, NA))
# create plot for each prototype
p1 = p + geom_point(data = pt1, color = "red", size = 4) + geom_density_2d(data = pt1, color = "red") +
  ggtitle(sprintf("%.3f MMD2", mmd2(dt, pt1)))

p2 = p + geom_point(data = pt2, color = "red", size = 4) +
  geom_density_2d(data = pt2, color = "red") +
  ggtitle(sprintf("%.3f MMD2", mmd2(dt, pt2)))

p3 = p + geom_point(data = pt3, color = "red", size = 4) +
  geom_density_2d(data = pt3, color = "red") +
  ggtitle(sprintf("%.3f MMD2", mmd2(dt, pt3)))
# TODO: Add custom legend for prototypes

# overlay mmd measure for each plot
gridExtra::grid.arrange(p, p1, p2, p3, ncol = 2)
```


<!--
A choice for the kernel is the radial basis function kernel:
-->
カーネルの選択は動径基底関数カーネルです。

$$k(x,x^\prime)=exp\left(-\gamma||x-x^\prime||^2\right)$$

<!--
where ||x-x'||^2^ is the Euclidean distance between two points and $\gamma$ is a scaling parameter.
The value of the kernel decreases with the distance between the two points and ranges between zero and one:
Zero when the two points are infinitely far apart;
one when the two points are equal.
-->
ここで、||x-x'||^2^ は2点間のユークリッド距離で $\gamma$ はスケールパラメータです。
カーネルの値は2点間の距離に応じて減少し、0と1の範囲に収まります。
2点間が無限遠にある時に 0 になり、同じ点にある時 1 になります。


<!--
We combine the MMD2 measure, the kernel and greedy search in an algorithm for finding prototypes:
-->
prototype を見つけるためのアルゴリズムとして MMD2、カーネル、貪欲法を組み合わせます。

<!--
- Start with an empty list of prototypes.
- While the number of prototypes is below the chosen number m:
    - For each point in the dataset, check how much MMD2 is reduced when the point is added to the list of prototypes. Add the data point that minimizes the MMD2 to the list.
- Return the list of prototypes.

The remaining ingredient for finding criticisms is the witness function, which tells us how much two density estimates differ at a particular point.
It can be estimated using:
-->

- prototype の空のリストを用意します。
- prototype の数は選ばれた m 個以下として、
    - データセット上のそれぞれの点が prototype のリストに追加された時に MMD2 がどのくらい減少するのか確認します。MMD2 を最小化するようなデータ点をリストに追加します。
- prototype のリストを返します。

criticism を探すための残りの成分は、ある点での2つの推定密度がどのくらい異なるのか知るための witness 関数になります。
これは次のように推定できます。

$$witness(x)=\frac{1}{n}\sum_{i=1}^nk(x,x_i)-\frac{1}{m}\sum_{j=1}^mk(x,z_j)$$

<!--
For two datasets (with the same features), the witness function gives you the means of evaluating in which empirical distribution the point x fits better.
To find criticisms, we look for extreme values of the witness function in both negative and positive directions.
The first term in the witness function is the average proximity between point x and the data, and, respectively, the second term is the average proximity between point x and the prototypes.
If the witness function for a point x is close to zero, the density function of the data and the prototypes are close together, which means that the distribution of prototypes resembles the distribution of the data at point x.
A negative witness function at point x means that the prototype distribution overestimates the data distribution (for example if we select a prototype but there are only few data points nearby);
a positive witness function at point x means that the prototype distribution underestimates the data distribution (for example if there are many data points around x but we have not selected any prototypes nearby).
-->
2つの同じ特徴量を持つデータセットがある時、witness関数は、点 x がどちらの経験的分布に良く適合するかを評価する手段となります。
criticism を見つけるために、witness 関数の外れ値を正負どちらの方向についても探します。
witness 関数の最初の項は点 x とデータの類似度の平均で、同様に、2番目の項はデータ点と prototype 間の類似度の平均です。
ある点 x での witness 関数が 0 に近づくと、データとプロトタイプの密度関数は互いに近づきます。これはプロトタイプの分布が点 x でのデータの分布と類似することです。
witness 関数が点 x で負であるとき、prototype の分布はデータの分布を過大評価しています(例えば、prototype を1つ選んだのに近くにデータ点が少ししかない時など)。
一方、正のとき、プロトタイプの分布はデータの分布を過小評価しています(例えば、x の周りのデータ点が沢山あるのに、近くの prototype を1つも選ばないなど)。

<!--
To give you more intuition, let us reuse the prototypes from the plot beforehand with the lowest MMD2 and display the witness function for a few manually selected points.
The labels in the following plot show the value of the witness function for various points marked as triangles.
Only the point in the middle has a high absolute value and is therefore a good candidate for a criticism.
-->
より直感的に理解するために、先ほどプロットした prototype のうち最も小さな MMD2 をもつものを再利用して、いくつか手動で選んだ点に対する witness 関数を表示してみましょう。
次の図のラベルは、三角形で表された様々な点に関する witness 関数の値を示しています。
中央の点のみが大きな絶対値をもつことから、criticism として良い候補になります。

<!--
fig.cap = "Evaluations of the witness function at different points."
-->

```{r witness, fig.cap = "異なる点における witness 関数の評価", cache = FALSE, dependson = "mmd"}
witness = function(x, dist1, dist2, sigma = 1) {
  k1 = apply(dist1, 1, function(z) radial(x, z, sigma = sigma))
  k2 = apply(dist2, 1, function(z) radial(x, z, sigma = sigma))
  mean(k1) - mean(k2)
}

w.points.indices = c(125, 2, 60, 19, 100)
wit.points = dt[w.points.indices,]
wit.points$witness = apply(wit.points, 1, function(x) round(witness(x[c("x1", "x2")], dt, pt2, sigma = 1), 3))

p + geom_point(data = pt2, color = "red") +
  geom_density_2d(data = pt2, color = "red") +
  ggtitle(sprintf("%.3f MMD2", mmd2(dt, pt2))) +
  geom_label(data = wit.points, aes(label = witness), alpha = 0.9, vjust = "top") +
    geom_point(data = wit.points, color = "black", shape = 17, size = 4)
```

<!--
The witness function allows us to explicitly search for data instances that are not well represented by the prototypes.
Criticisms are points with high absolute value in the witness function.
Like prototypes, criticisms are also found through greedy search.
But instead of reducing the overall MMD2, we are looking for points that maximize a cost function that includes the witness function and a regularizer term.
The additional term in the optimization function enforces diversity in the points, which is needed so that the points come from different clusters.

This second step is independent of how the prototypes are found.
I could also have handpicked some prototypes and used the procedure described here to learn criticisms.
Or the prototypes could come from any clustering procedure, like k-medoids.
-->
witness 関数を使うことで、prototype によって上手く表されていないデータインスタンスを明示的に探すことができます。
criticism は witness 関数の出力の中で、高い絶対値を持つ点のことを言います。
prototype と同様に、criticism も貪欲法により探索されます。
しかし、全体の MMD2 を減らすのではなく、witness 関数と正則化項を含むコスト関数を最大化する点が探されます。
正則化項は、異なるクラスターから点が選択されるよう、点の多様性を強制します。

この2つ目のステップは、prototype の決定方法とは独立しています。
criticism を学ぶため、ここで述べた手順といくつかの prototype を選んでみます。
もしくは、prototype は、例えば k-medoids のようなクラスタリング手法により選択できます。


<!--
That is it with the important parts of MMD-critic theory.
One question remains:
**How can MMD-critic be used for interpretable machine learning?**

MMD-critic can add interpretability in three ways:
By helping to better understand the data distribution;
by building an interpretable model;
by making a black box model interpretable.

If you apply MMD-critic to your data to find prototypes and criticisms, it will improve your understanding of the data, especially if you have a complex data distribution with edge cases.
But with MMD-critic you can achieve more!
-->
これで、MMD-critic 理論の重要な部分は以上です。
ただし、1つ疑問が残されています。
**機械学習の解釈性に、MMD-criticはどのように使われるのか**ということです。

MMD-critic は、1) データの分布の理解に役立つ、2) 解釈可能なモデルを構築する、3) ブラックボックスを解釈可能にする という3つの観点で、解釈性に寄与します。
prototype と criticism を探すために、データセットに MMD-critic を適用すると、データへの理解が深まります。
しかし、MMD-critic を用いると、さらに期待できることがあります。

<!--
For example, you can create an interpretable prediction model: a so-called "nearest prototype model".
The prediction function is defined as:
-->
例えば、解釈可能な予測モデルを作ることもできます。
これを"nearest prototype model"と呼びましょう。
この予測モデルは以下のように定義されます。

$$\hat{f}(x)=argmax_{i\in{}S}k(x,x_i)$$

<!--
which means that we select the prototype i from the set of prototypes S that is closest to the new data point, in the sense that it yields the highest value of the kernel function.
The prototype itself is returned as an explanation for the prediction.
This procedure has three tuning parameters:
The type of kernel, the kernel scaling parameter and the number of prototypes.
-->
このモデルは、カーネル関数の出力が大きいという意味で、新しいデータに最も近い prototype が S から選ばれるという意味になります。
prototype 自体は、予測結果に対する説明として考えられます。
この方法には、カーネルの種類、カーネルのスケールパラメータ、prototypeの数という3つのハイパーパラメータがあります。

<!--
All parameters can be optimized within a cross validation loop.
The criticisms are not used in this approach.

As a third option, we can use MMD-critic to make any machine learning model globally explainable by examining prototypes and criticisms along with their model predictions.
The procedure is as follows:

1. Find prototypes and criticisms with MMD-critic.
1. Train a machine learning model as usual.
1. Predict outcomes for the prototypes and criticisms with the machine learning model.
1. Analyse the predictions: In which cases was the algorithm wrong?
Now you have a number of examples that represent the data well and help you to find the weaknesses of the machine learning model.
-->
全てのパラメータは、クロスバリデーションで最適化できます。
criticism はこのアプローチでは使われません。

3つ目の MMD-critic の使い方として、prototype と criticism により任意の機械学習モデルを大域的に説明可能にできます。
方法としては、次の通りです。

1. prototype と criticism を MMD-critic を用いて探索
1. 機械学習モデルを学習
1. prototype と criticism に対して、学習された機械学習モデルを用いて、予測結果を取得
1. 予測結果を解析: どのケースでモデルは予測を間違えたのか。
これにより、機械学習モデルの弱点を見つけることができ、またデータをよく表現するいくつからのサンプルを見つけることができます。


<!--
How does that help?
Remember when Google's image classifier identified black people as gorillas?
Perhaps they should have used the procedure described here before deploying their image recognition model.
It is not enough just to check the performance of the model, because if it were 99% correct, this issue could still be in the 1%.
And labels can also be wrong!
Going through all the training data and performing a sanity check if the prediction is problematic might have revealed the problem, but would be infeasible.
But the selection of -- say a few thousand -- prototypes and criticisms is feasible and could have revealed a problem with the data:
It might have shown that there is a lack of images of people with dark skin, which indicates a problem with the diversity in the dataset.
Or it could have shown one or more images of a person with dark skin as a prototype or (probably) as a criticism with the notorious "gorilla" classification.
I do not promise that MMD-critic would certainly intercept these kind of mistakes, but it is a good sanity check.
-->
これはどのような意味があるでしょうか。
Google の画像分類モデルが、黒人をゴリラとして分類した問題を思い出してください。
おそらく、彼らは、画像認識モデルをデプロイする前に、これらの手法を適用するべきだったのでは無いでしょうか。
99% 正しくても、この問題は残りの 1% にある問題なので、モデルの性能を確認するだけでは、不十分です。
そして、ラベルも間違っていることがあります。
全ての学習データを通して、予測結果に問題が無いか確認していれば、この問題は事前に明らかになったかもしれませんが、それは不可能です。
しかし、数千程度の prototype と ciriticisms を選択と確認し、データに関する問題を明らかにしたでしょう。
肌の黒い人の画像が少なく、つまりデータセットの多様性に問題があることを事前に明らかにできたかもしれません。
あるいは、肌の色が濃い人を prototype として、あるいは悪名高い「ゴリラ」という分類で criticism として、1つ以上の画像を表示していたかもしれません。
MMD-critic が確実にこの類のミスを取り除くとは約束できませんが、よいチェックにはなるでしょう。

<!-- ### Examples -->
### 例

<!--
The following example of MMD-critic uses a handwritten digit dataset.

Looking at the actual prototypes, you might notice that the number of images per digit is different.
This is because a fixed number of prototypes were searched across the entire dataset and not with a fixed number per class.
As expected, the prototypes show different ways of writing the digits.
-->
MMD-critic の次の例では、手書き数字データセットを使っています。

実際の prototype の見ると、数字ごとの画像の枚数が異なることに気づくかもしれません。
これはクラスごとに固定の数を決めて prototype を選んだ訳ではなく、データセット全体で固定の数を決めて prototype を選んだためです。
予想通り、prototype は各数字の異なる書き方のものが選ばれています。

<!--
fig.cap = "Prototypes for a handwritten digits dataset."
-->

```{r, prototype-and-criticisms2, fig.cap = "手書き数字データセットにおける prototype", out.width=600}
knitr::include_graphics("images/proto-critique2.jpg")
```
<!--
### Advantages
-->
### 長所

<!--
In a user study the authors of MMD-critic gave images to the participants, which they had to visually match to one of two sets of images, each representing one of two classes (e.g. two dog breeds).
The **participants performed best when the sets showed prototypes and criticisms** instead of random images of a class.

You are free to **choose the number of prototypes and criticisms**.

MMD-critic works with density estimates of the data.
This **works with any type of data and any type of machine learning model**.

The algorithm is **easy to implement**.
-->
ユーザ研究において、MMD-critic の著者は参加者に画像を与えました。参加者は（犬種など）2つのクラスの1つをそれぞれ表す二枚の画像の内、視覚的にマッチする一枚を選ぶ必要があります。
参加者は、ランダムな画像ではなく、prototype と criticism である画像を与えらた場合に、最高のパフォーマンスを示しました。

prototype と criticism の数は自由に選ぶことができます。
MMD-critic はデータの密度推定にも使えます。
また、MMD-critic はどんなタイプのデータでも、どんなタイプの機械学習モデルにも使うことができます。

アルゴリズムの実装も簡単です。

<!--
MMD-critic is very flexible in the way it is used to increase interpretability.
It can be used to understand complex data distributions.
It can be used to build an interpretable machine learning model.
Or it can shed light on the decision making of a black box machine learning model.

**Finding criticisms is independent of the selection process of the prototypes**.
But it makes sense to select prototypes according to MMD-critic, because then both prototypes and criticisms are created using the same method of comparing prototypes and data densities.
-->
MMD-critic は解釈性を高めるために使う方法において非常に柔軟です。
複雑なデータ分布を理解するために使用できます。
解釈可能な機械学習モデルを作るために使用できます。
あるいは、black box モデルを理解するために役立ちます。

**criticisms を見つけることは、prototype を選ぶプロセスとは独立しています**。
しかし、MMD-critic に従って prototype を選ぶことは理にかなっています。なぜなら、prototype も criticisms も、prototype とデータ密度を比較する同じ方法で作れられるためです。

<!--
### Disadvantages
-->
### 短所

<!--
While, mathematically, prototypes and criticisms are defined differently, their **distinction is based on a cut-off value** (the number of prototypes).
Suppose you choose a too low number of prototypes to cover the data distribution.
The criticisms would end up in the areas that are not that well explained.
But if you were to add more prototypes they would also end up in the same areas.
Any interpretation has to take into account that criticisms strongly depend on the existing prototypes and the (arbitrary) cut-off value for the number of prototypes.
-->
数学的には、prototype と criticism は異なる定義ですが、これらの違いは、カットオフ値（prototype の数）に基づいています。
データの分布をカバーするために、少ない数の prototype を選択したとします。
この場合、criticisims はうまく説明されていない部分に集中してしまいます。
しかし、より多くの prototype を追加したとしても、同じ範囲に集まってしまうでしょう。
どのような解釈をするにしても、criticisims は prototype の数を決定する（任意の）カットオフ値と既存の prototype に強く依存することを考慮に入れる必要があります。

<!--
You have to **choose the number of prototypes and criticisms**.
As much as this can be nice-to-have, it is also a disadvantage.
How many prototypes and criticisms do we actually need?
The more the better? The less the better?
One solution is to select the number of prototypes and criticisms by measuring how much time humans have for the task of looking at the images, which depends on the particular application.
-->
**prototype と criticisims の数を選ぶ必要があります**。
これはメリットにもなりますが、デメリットにもなります。
どの程度の prototype と criticism の数が実際必要でしょうか。
さらに多い方が良いのでしょうか、それとも少ない方が良いのでしょうか。
1つの答えは、人がどれくらいの時間で画像を見ているかを計測することで、prototype と criticism を決める方法です。

<!--
Only when using MMD-critic to build a classifier do we have a way to optimize it directly.
One solution could be a screeplot showing the number of prototypes on the x-axis and the MMD2 measure on the y-axis.
We would choose the number of prototypes where the MMD2 curve flattens.
-->
MMD-critic を用いて分類器を作成する場合、直接最適化する方法があります。
1つの解決手段は、横軸に prototype の数をとり、縦軸に MMD2 の値をプロットして見てみることです。
こうすることで、MMD2 カーブがフラットになったところで、prototype の数を選ぶことができます。

<!--
The other parameters are the choice of the kernel and the kernel scaling parameter.
We have the same problem as with the number of prototypes and criticisms:
**How do we select a kernel and its scaling parameter?**
Again, when we use MMD-critic as a nearest prototype classifier, we can tune the kernel parameters.
For the unsupervised use cases of MMD-critic, however, it is unclear.
(Maybe I am a bit harsh here, since all unsupervised methods have this problem.)
-->
他のパラメータは、カーネルとカーネルのスケールパラメータになります。
ここで、prototype と criticism の数の場合と同様の問題があります。
**どのようにカーネルとカーネルのスケールパラメータを選べば良いでしょうか**。
繰り返しになりますが、MMD-critic を最も近い prototype を返す分類器として使う場合、カーネルパラメータも調整できます。
しかし、MMD-critic の教師なしにおけるユースケースの場合、明らかではありません。
全ての教師なし手法は同様の問題を抱えているため、少し難しいかもしれません。

<!--
It takes all the features as input, **disregarding the fact that some features might not be relevant** for predicting the outcome of interest.
One solution is to use only relevant features, for example image embeddings instead of raw pixels.
This works as long as we have a way to project the original instance onto a representation that contains only relevant information.

There is some code available, but it is **not yet implemented as nicely packaged and documented software**.
-->
これは、すべての特徴量を入力として受け取り、**いくつかの特徴量が関心のある結果を予測するために関連性がないかもしれない**という事実を無視しています。
1つの解決策は、生の画像の代わりに、例えば画像の埋め込みなどの関連する特徴量のみを使うことです。
これは、元のインスタンスを、関連する情報のみを含む表現に射影する方法がある場合のみ有効です。

利用できるコードはありますが、綺麗にパッケージ化され、かつドキュメントがあるものはまだありません。

<!--
### Code and Alternatives
-->
### コードと代替手法

<!--
An implementation of MMD-critic can be found here: [https://github.com/BeenKim/MMD-critic](https://github.com/BeenKim/MMD-critic).

The simplest alternative to finding prototypes is [k-medoids](https://en.wikipedia.org/wiki/K-medoids) by Kaufman et. al (1987).[^medoids]

[^medoids]: Kaufman, Leonard, and Peter Rousseeuw. "Clustering by means of medoids". North-Holland (1987).

[^critique]: Kim, Been, Rajiv Khanna, and Oluwasanmi O. Koyejo. "Examples are not enough, learn to criticize! Criticism for interpretability." Advances in Neural Information Processing Systems (2016).
-->
MMD-critic の実装は以下にあります。
[https://github.com/BeenKim/MMD-critic](https://github.com/BeenKim/MMD-critic).

prototype を見つけるための、最もシンプルな代替手法は以下です。
[k-medoids](https://en.wikipedia.org/wiki/K-medoids) by Kaufman et. al (1987).[^medoids]

[^medoids]: Kaufman, Leonard, and Peter Rousseeuw. "Clustering by means of medoids". North-Holland (1987).

[^critique]: Kim, Been, Rajiv Khanna, and Oluwasanmi O. Koyejo. "Examples are not enough, learn to criticize! Criticism for interpretability." Advances in Neural Information Processing Systems (2016).
